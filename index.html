<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Climate Analytics Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #007bff; --bg: #f8f9fa; --card-bg: #ffffff; --text: #2d3436;
      --sub-text: #636e72; --max-color: #ff7675; --min-color: #74b9ff;
      --border: #dfe6e9; --ribbon-bg: #e9ecef; --map-invert: 0;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --sub-text: #a0a0a0; --border: #333; --ribbon-bg: #2d2d2d; --map-invert: 0.9; }
    }

    body { margin:0; padding:0; font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); overflow-x: hidden; }
    .top-header { text-align: center; margin: 30px 0 5px 0; font-weight: 300; font-size: 1.8rem; letter-spacing: -0.5px; }
    #stationHeader {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
        color: var(--primary);
        font-weight: 600;
        font-size: 1.1rem;
        min-height: 1.6em;
        flex-wrap: wrap;
    }
    
    .station-id-badge {
        display: inline-flex;
        align-items: center;
        background: var(--ribbon-bg);
        color: var(--sub-text);
        font-size: 0.7rem;
        padding: 0 8px;
        height: 20px;
        border-radius: 4px;
        font-weight: 500;
        border: 1px solid var(--border);
        letter-spacing: 0.5px;
        line-height: 1;
    }

    .state-badge {
        background: var(--card-bg);
        color: var(--sub-text);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 700;
        border: 1px solid var(--border);
        text-transform: uppercase;
        flex-shrink: 0;
    }

    .station-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        cursor: pointer;
    }

    #map { 
      height: 400px; width: 92%; max-width: 1200px; margin: 0 auto 25px auto; 
      border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
      border: 1px solid var(--border);
      filter: invert(var(--map-invert)) hue-rotate(180deg) brightness(0.9);
    }

    /* Container for the control */
    .leaflet-control-locate {
        background: var(--card-bg); /* Use your theme variable */
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    /* Match the exact Leaflet button style */
    /* Target the 'a' tag specifically to override Leaflet's default white background */
    .leaflet-control-locate a {
        background-color: var(--card-bg) !important;
        color: var(--text) !important;
        border-bottom: none; /* Removes the thin line often seen in leaflet-bar */
        display: flex !important;
        align-items: center;
        justify-content: center;
        width: 30px !important;
        height: 30px !important;
    }
    
    /* Ensure the hover state matches your theme */
    .leaflet-control-locate a:hover {
        background-color: var(--ribbon-bg) !important;
        color: var(--primary) !important;
    }
    
    /* Adjust the SVG to sit centered */
    .leaflet-control-locate svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
    }
    
    /* This matches the border color to your theme variables */
    .leaflet-bar {
        border: 1px solid var(--border) !important;
    }

    #controls { 
      margin: 0 auto 25px auto; 
      padding: 15px 20px; 
      background: var(--card-bg); 
      border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
      display: flex; 
      gap: 20px; 
      align-items: center; 
      justify-content: center; 
      width: fit-content; 
      max-width: 92%;
      border: 1px solid var(--border); 
      flex-wrap: wrap;
    }

    .search-container { 
      position: relative; 
      width: 240px; 
      flex-shrink: 0; 
      display: flex; 
      align-items: center; 
    }

    @media (max-width: 600px) {
      .search-container {
        width: 100%;
        justify-content: center;
      }
      #controls {
        border-radius: 20px;
        gap: 15px;
      }
    }
    #stationSearch { 
        width: 100%; padding: 8px 35px 8px 15px; border-radius: 20px; border: 1px solid var(--border); 
        background: var(--bg); color: var(--text); font-family: inherit; outline: none; font-size: 0.85rem; box-sizing: border-box;
    }
    #clearSearch { position: absolute; right: 10px; cursor: pointer; color: var(--sub-text); font-weight: 800; display: none; user-select: none; font-size: 1.1rem; line-height: 1; }
    #clearSearch:hover { color: var(--max-color); }

    #searchResults { position: absolute; top: 42px; left: 0; width: 320px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; max-height: 250px; overflow-y: auto; z-index: 9999; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; }
    .search-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.8rem; text-align: left; }
    .search-item:hover { background: var(--ribbon-bg); color: var(--primary); }

    .dropdown-group { display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
    select, #todayBtn { background: var(--bg); color: var(--text); padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; font-family: inherit; cursor: pointer; }

    #periodRibbon { margin: 0 auto 30px auto; display: flex; justify-content: center; gap: 5px; padding: 4px; background: var(--ribbon-bg); width: fit-content; border-radius: 30px; }
    .period-btn { padding: 8px 16px; border: none; background: transparent; border-radius: 25px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--sub-text); font-family: inherit; }
    .period-btn.active { background: var(--primary); color: white; }

    .stats-section { margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .stats-row { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; width: 100%; }
    .stat-card { background: var(--card-bg); padding: 20px; border-radius: 12px; text-align: center; width: 300px; border: 1px solid var(--border); position: relative; }
    .stat-card.daily { border: 2px solid var(--border); border-bottom-width: 5px; }
    .stat-card.min { border-bottom: 3px solid var(--min-color); }
    .stat-card.max { border-bottom: 3px solid var(--max-color); }
    .stat-value { font-size: 1.8rem; font-weight: 800; display: block; margin-top: 6px; }
    .stat-label { font-size: 0.75rem; font-weight: 800; color: var(--sub-text); letter-spacing: 0.8px; line-height: 1.4; display: block; min-height: 4.2em; }
    
    .departure-info { font-size: 0.75rem; font-weight: 700; margin-top: 8px; display: block; }

    .switch { position: relative; display: inline-block; width: 36px; height: 18px; margin: 0 6px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider:before { transform: translateX(18px); }

    .unit-label { transition: color 0.3s ease; }
    .unit-active { color: var(--primary) !important; }

    #plots { display: flex; justify-content: center; padding: 0 4%; flex-wrap: wrap; gap: 20px; margin-bottom: 60px; }
    #boxDiv, #lineDiv { background: var(--card-bg); padding: 15px; border-radius: 20px; width: 46%; height: 400px; min-width: 380px; border: 1px solid var(--border); }
  </style>
</head>
<body>

<h2 class="top-header">Daily Climate Analytics Dashboard</h2>
<div id="stationHeader">Select a station marker on the map or search to begin.</div>

<div id="map"></div>

<div id="controls">
    <div class="search-container">
        <input type="text" id="stationSearch" placeholder="Search station name or ID...">
        <span id="clearSearch">&times;</span>
        <div id="searchResults"></div>
    </div>
    
    <div class="dropdown-group">
        <select id="month">
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
        <select id="day"></select>
        <button id="todayBtn">Today</button>
    </div>

    <div style="display:flex; align-items:center; border-left:1px solid var(--border); padding-left:15px; flex-shrink:0;">
        <span id="labelC" class="unit-label" style="font-size:0.7rem; font-weight:700">°C</span>
        <label class="switch"><input type="checkbox" id="unitToggle" checked><span class="slider"></span></label>
        <span id="labelF" class="unit-label" style="font-size:0.7rem; font-weight:700">°F</span>
    </div>
</div>

<div id="periodRibbon">
  <button class="period-btn" data-start="1961" data-end="1990">1961-1990</button>
  <button class="period-btn" data-start="1971" data-end="2000">1971-2000</button>
  <button class="period-btn" data-start="1981" data-end="2010">1981-2010</button>
  <button class="period-btn" data-start="1991" data-end="2020" id="defaultPeriod">1991-2020</button>
  <button class="period-btn" data-start="0" data-end="9999">All Data</button>
</div>

<div class="stats-section" id="liveRow" style="display:none; margin-bottom: 30px;">
    <div class="stats-row">
        <div class="stat-card" style="border-bottom: 4px solid var(--min-color);">
            <span class="stat-label" id="liveMinLabel">Today's Observed Minimum Temperature</span>
            <span class="stat-value" id="liveMin">--</span>
            <span class="departure-info" id="liveMinDep"></span>
        </div>
        <div class="stat-card" style="border-bottom: 4px solid var(--max-color);">
            <span class="stat-label" id="liveMaxLabel">Today's Observed Maximum Temperature</span>
            <span class="stat-value" id="liveMax">--</span>
            <span class="departure-info" id="liveMaxDep"></span>
        </div>
    </div>
</div>

<div class="stats-section">
  <div class="stats-row">
    <div class="stat-card min daily"><span class="stat-label" id="dayMinLabel">Average Minimum Temperature</span><span class="stat-value" id="avgMin">--</span></div>
    <div class="stat-card max daily"><span class="stat-label" id="dayMaxLabel">Average Maximum Temperature</span><span class="stat-value" id="avgMax">--</span></div>
  </div>
  <div class="stats-row">
    <div class="stat-card min"><span class="stat-label" id="monMinLabel">Average Minimum Temperature</span><span class="stat-value" id="monMin">--</span></div>
    <div class="stat-card max"><span class="stat-label" id="monMaxLabel">Average Maximum Temperature</span><span class="stat-value" id="monMax">--</span></div>
  </div>
  <div class="stats-row">
    <div class="stat-card min"><span class="stat-label" id="currMonthMinLabel">Average Minimum Temperature</span><span class="stat-value" id="currMonthMin">--</span></div>
    <div class="stat-card max"><span class="stat-label" id="currMonthMaxLabel">Average Maximum Temperature</span><span class="stat-value" id="currMonthMax">--</span></div>
  </div>
</div>

<div id="plots">
  <div id="boxDiv"></div>
  <div id="lineDiv"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let lastStation = null, fullDataset = null, allStations = [], currentRange = { start: 1991, end: 2020 };
  let dailyReferenceValues = { tmin: [], tmax: [] }; 
  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

  const map = L.map('map', { zoomSnap: 0.5 }).setView([35.5, -80], 7);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
  const markers = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 40 });

  // Define a custom Leaflet Control
  const LocateControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(map) {
          // Create the main container with Leaflet's 'leaflet-bar' class
          const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate');

          // Create a link element to match the structure of Zoom buttons
          const link = L.DomUtil.create('a', '', container);
          link.href = '#';
          link.title = "Find nearest station";
          link.role = "button";
          link.ariaLabel = "Find nearest station";

          link.innerHTML = `
              <svg viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
              </svg>`;

          // Move the click event to the link
          link.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();

              if (!navigator.geolocation) {
                  alert("Geolocation is not supported");
                  return;
              }

              // Your existing geolocation logic here...
              navigator.geolocation.getCurrentPosition((position) => {
                  const userLat = position.coords.latitude;
                  const userLon = position.coords.longitude;
                  if (allStations.length === 0) return;
                  let closest = null;
                  let minDist = Infinity;
                  allStations.forEach(st => {
                      if (!st.lat || !st.lon) return;
                      const d = Math.sqrt(Math.pow(userLat - st.lat, 2) + Math.pow(userLon - st.lon, 2));
                      if (d < minDist) {
                          minDist = d;
                          closest = st;
                      }
                  });
                  if (closest) {
                      map.flyTo([userLat, userLon], 10);
                      setTimeout(() => selectStation(closest), 1000);
                  }
              }, () => alert("Location access denied"));
          };

          return container;
      }
  });

  map.addControl(new LocateControl());

  function getStationStyles(id) {
    if (id.startsWith('USC')) return { fill: 'rgba(16, 172, 132, 0.3)', stroke: '#10ac84' };
    if (id.startsWith('USR')) return { fill: 'rgba(243, 156, 18, 0.3)', stroke: '#f39c12' };
    if (id.startsWith('USW')) return { fill: 'rgba(46, 134, 222, 0.3)', stroke: '#2e86de' };
    return { fill: 'rgba(149, 165, 166, 0.3)', stroke: '#95a5a6' };
  }

  Papa.parse('data/stations.csv', {
    download: true, header: true, skipEmptyLines: true,
    complete: function(results) {
      allStations = results.data;
      allStations.forEach(st => {
        if(!st.lat || !st.lon) return;
        const styles = getStationStyles(st.station);
        const dot = L.circleMarker([parseFloat(st.lat), parseFloat(st.lon)], {
          radius: 6, fillColor: styles.fill, color: styles.stroke, weight: 2, opacity: 1, fillOpacity: 1
        });
        dot.bindTooltip(`${st.name}, ${st.state || ''}`);
        dot.on('click', () => selectStation(st));
        markers.addLayer(dot);
      });
      map.addLayer(markers);
    }
  });

  const searchInput = document.getElementById('stationSearch');
  searchInput.value = '';
  const searchResults = document.getElementById('searchResults');
  const clearBtn = document.getElementById('clearSearch');

  searchInput.addEventListener('input', (e) => {
    const val = e.target.value.toLowerCase();
    clearBtn.style.display = val.length > 0 ? 'block' : 'none';
    searchResults.innerHTML = '';
    if (val.length < 2) { searchResults.style.display = 'none'; return; }
    const filtered = allStations.filter(s => s.name.toLowerCase().includes(val) || s.station.toLowerCase().includes(val)).slice(0, 15);
    if (filtered.length > 0) {
        filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = 'search-item';

                // This line adds the name, the ID below it, and the State Badge on the right
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <strong>${s.name}</strong><br>
                            <small style="color:var(--sub-text)">${s.station}</small>
                        </div>
                        <span class="state-badge">${s.state || ''}</span>
                    </div>
                `;
                  
                div.onclick = () => { 
                    selectStation(s); 
                    searchResults.style.display = 'none'; 
                    searchInput.value = ''; 
                    clearBtn.style.display = 'none'; 
                };
                searchResults.appendChild(div);
            });
        searchResults.style.display = 'block';
    } else { searchResults.style.display = 'none'; }
  });

  clearBtn.onclick = () => { searchInput.value = ''; clearBtn.style.display = 'none'; searchResults.style.display = 'none'; searchInput.focus(); };

  document.addEventListener('click', (e) => {
    // We check if the click was anywhere OTHER than the input or the results box
    const isClickInsideSearch = searchInput.contains(e.target) || searchResults.contains(e.target);

    if (!isClickInsideSearch) {
        searchResults.style.display = 'none';
    }
  });

  function selectStation(st) {
    lastStation = st;
    map.setView([st.lat, st.lon], 11);
    triggerDataFetch();
  }

  function triggerDataFetch() {
      if (!lastStation) return;
      const statePath = (lastStation.state || 'UNK').toUpperCase();
      const filePath = `data/daily/${statePath}/${lastStation.station}.csv`;

      Papa.parse(filePath, {
        download: true, 
        header: true, 
        dynamicTyping: true, 
        skipEmptyLines: true,
        complete: function(results) {
          fullDataset = results.data;

          // Filter out any rows without a valid date to calculate year range
          const validRows = fullDataset.filter(d => d.DATE);
          const years = validRows.map(d => parseInt(d.DATE.split('-')[0]));

          const minYear = Math.min(...years);
          const maxYear = Math.max(...years);

          // Update the header with the Name, Station ID Badge, and Date Range
          document.getElementById('stationHeader').innerHTML = `
              <span>Station:</span>
              <span style="color:var(--text)">${lastStation.name}, ${lastStation.state}</span>
              <span class="station-id-badge">${lastStation.station}</span>
              <span style="font-size:0.85rem; color:var(--sub-text); font-weight:400;">
                  (${minYear}–${maxYear})
              </span>
          `;
            
          processAndPlot();
        },
        error: function() {
          document.getElementById('stationHeader').innerHTML = 
              `<span style="color:var(--max-color)">Error: Data not found for station ${lastStation.station}.</span>`;
        }
      });
    }

  function populateDays(selectedDay = null) {
    const month = parseInt(document.getElementById('month').value);
    const daySelect = document.getElementById('day');
    const daysInMonth = new Date(2024, month, 0).getDate();
    const prevVal = selectedDay || parseInt(daySelect.value) || 1;
    daySelect.innerHTML = '';
    for (let i = 1; i <= daysInMonth; i++) {
      const opt = document.createElement('option');
      opt.value = i; opt.innerHTML = i;
      if (i === prevVal || (i === daysInMonth && prevVal > daysInMonth)) opt.selected = true;
      daySelect.appendChild(opt);
    }
  }

  function updateToggleColors() {
    const isF = document.getElementById('unitToggle').checked;
    const labelC = document.getElementById('labelC');
    const labelF = document.getElementById('labelF');
    if (isF) { labelF.classList.add('unit-active'); labelC.classList.remove('unit-active'); }
    else { labelC.classList.add('unit-active'); labelF.classList.remove('unit-active'); }
  }

  const now = new Date();
  document.getElementById('month').value = now.getMonth() + 1;
  populateDays(now.getDate());
  document.getElementById('defaultPeriod').classList.add('active');
  updateToggleColors();

  document.getElementById('month').addEventListener('change', () => { populateDays(); triggerDataFetch(); });
  document.getElementById('day').addEventListener('change', triggerDataFetch);
  document.getElementById('unitToggle').addEventListener('change', () => { updateToggleColors(); processAndPlot(); });
  document.getElementById('todayBtn').addEventListener('click', () => {
    const d = new Date();
    document.getElementById('month').value = d.getMonth() + 1;
    populateDays(d.getDate());
    triggerDataFetch();
  });

  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentRange.start = parseInt(this.dataset.start);
      currentRange.end = parseInt(this.dataset.end);
      processAndPlot();
    });
  });

  async function fetchLiveComparison(lat, lon, normalHighVal, normalLowVal) {
      const liveRow = document.getElementById('liveRow');
      const isF = document.getElementById('unitToggle').checked;
      const unit = isF ? "°F" : "°C";

      try {
          const pointRes = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
          const pointData = await pointRes.json();
          const hourlyUrl = pointData.properties.forecastHourly;
          
          const stationListRes = await fetch(pointData.properties.observationStations);
          const stationListData = await stationListRes.json();
          const stationFeature = stationListData.features[0];
          const stationId = stationFeature.properties.stationIdentifier;
          const stationName = stationFeature.properties.name;

          const [hourlyRes, obsRes] = await Promise.all([
              fetch(hourlyUrl),
              fetch(`https://api.weather.gov/stations/${stationId}/observations`)
          ]);

          const hourlyData = await hourlyRes.json();
          const obsData = await obsRes.json();
          const todayStr = new Date().toDateString();

          const todayObsF = obsData.features
              .filter(obs => new Date(obs.properties.timestamp).toDateString() === todayStr)
              .map(obs => obs.properties.temperature.value)
              .filter(v => v !== null)
              .map(v => (v * 9/5 + 32));

          const actualLowF = todayObsF.length ? Math.min(...todayObsF) : null;
          const actualHighF = todayObsF.length ? Math.max(...todayObsF) : null;

          const currentTime = new Date();
          const forecastRemainingF = hourlyData.properties.periods
              .filter(p => new Date(p.startTime).toDateString() === todayStr)
              .filter(p => new Date(p.startTime) >= currentTime)
              .map(p => p.temperature);

          const forecastLowF = forecastRemainingF.length ? Math.min(...forecastRemainingF) : null;
          const forecastHighF = forecastRemainingF.length ? Math.max(...forecastRemainingF) : null;

          let finalLowF = actualLowF;
          if (forecastLowF !== null) finalLowF = (finalLowF === null) ? forecastLowF : Math.min(finalLowF, forecastLowF);

          let finalHighF = actualHighF;
          if (forecastHighF !== null) finalHighF = (finalHighF === null) ? forecastHighF : Math.max(finalHighF, forecastHighF);

          const dispHigh = isF ? finalHighF : (finalHighF - 32) * 5/9;
          const dispLow = isF ? finalLowF : (finalLowF - 32) * 5/9;

          liveRow.style.display = 'flex';
          document.getElementById('liveMin').textContent = dispLow.toFixed(1) + unit;
          document.getElementById('liveMax').textContent = dispHigh.toFixed(1) + unit;

          const sourceTag = `<br><span style="font-size:0.6rem; color:var(--sub-text); font-weight:400; text-transform:none;">Source: ${stationName}</span>`;
          
          const isMinObserved = actualLowF !== null && (forecastLowF === null || actualLowF <= forecastLowF);
          const isMaxObserved = actualHighF !== null && (forecastHighF === null || actualHighF >= forecastHighF);

          document.getElementById('liveMinLabel').innerHTML = (isMinObserved ? "Observed Minimum Temperature" : "Projected Minimum Temperature") + sourceTag;
          document.getElementById('liveMaxLabel').innerHTML = (isMaxObserved ? "Observed Maximum Temperature" : "Projected Maximum Temperature") + sourceTag;

          updateDepartureBadge('liveMinDep', dispLow, normalLowVal, dailyReferenceValues.tmin);
          updateDepartureBadge('liveMaxDep', dispHigh, normalHighVal, dailyReferenceValues.tmax);

      } catch (e) {
          console.error("Live fetch failed", e);
          liveRow.style.display = 'none';
      }
  }

  function updateDepartureBadge(id, current, normal, referenceValues) {
      const el = document.getElementById(id);
      if (normal === "--" || !referenceValues || referenceValues.length === 0) { el.textContent = ""; return; }
      
      const cleanNormal = parseFloat(normal.toString().replace(/[^\d.-]/g, ''));
      const diffNum = parseFloat(current) - cleanNormal;
      const diffStr = diffNum.toFixed(1);
      
      if (isNaN(diffNum)) { el.textContent = ""; return; }

      const avg = referenceValues.reduce((a, b) => a + b, 0) / referenceValues.length;
      const stdDev = Math.sqrt(referenceValues.reduce((s, v) => s + Math.pow(v - avg, 2), 0) / referenceValues.length);
      const sigma = stdDev > 0 ? Math.abs(diffNum) / stdDev : 0;

      let classification = "Normal";
      if (sigma > 2) classification = (diffNum > 0 ? "Well Above" : "Well Below") + " Normal";
      else if (sigma > 1) classification = (diffNum > 0 ? "Above" : "Below") + " Normal";

      const fullText = `${diffNum > 0 ? '+' : ''}${diffStr}° from daily average (${classification})`;

      if (diffNum > 0.05) {
          el.style.color = "var(--max-color)";
          el.textContent = fullText;
      } else if (diffNum < -0.05) {
          el.style.color = "var(--min-color)";
          el.textContent = fullText;
      } else {
          el.style.color = "var(--sub-text)";
          el.textContent = `Exactly at daily average (Normal)`;
      }
  }

  function processAndPlot() {
    if (!fullDataset) return;
    const mIdx = parseInt(document.getElementById('month').value);
    const dReq = parseInt(document.getElementById('day').value);
    const isF = document.getElementById('unitToggle').checked;
    const unit = isF ? "°F" : "°C";
    const convert = (v) => (v == null ? null : (isF ? (v * 9/5 + 32) : v));
    const monthName = monthNames[mIdx - 1];
    
    // Formatting the year range string based on selection
    const rangeText = currentRange.start === 0 ? "All Available Data" : `${currentRange.start}–${currentRange.end}`;
    const rangeHtml = `<br><span style="font-size:0.65rem; color:var(--sub-text); font-weight:400; text-transform:none;">${rangeText}</span>`;

    // Update labels for the Daily and Historical Monthly Average cards with the date range
    document.getElementById('dayMinLabel').innerHTML = `${monthName} ${dReq} Average Minimum Temperature ${rangeHtml}`;
    document.getElementById('dayMaxLabel').innerHTML = `${monthName} ${dReq} Average Maximum Temperature ${rangeHtml}`;
    document.getElementById('monMinLabel').innerHTML = `${monthName} Average Minimum Temperature ${rangeHtml}`;
    document.getElementById('monMaxLabel').innerHTML = `${monthName} Average Maximum Temperature ${rangeHtml}`;

    const rawMonthData = fullDataset.filter(d => d.DATE && parseInt(d.DATE.split('-')[1]) === mIdx)
      .map(r => ({
        year: parseInt(r.DATE.split('-')[0]),
        day: parseInt(r.DATE.split('-')[2]),
        tmax: (r.TMAX != null) ? r.TMAX/10 : null,
        tmin: (r.TMIN != null) ? r.TMIN/10 : null
      }));

    const periodData = rawMonthData.filter(d => d.year >= currentRange.start && d.year <= currentRange.end);
    const dailyRows = periodData.filter(d => d.day === dReq);
    const getAvg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : "--";
    
    dailyReferenceValues.tmin = dailyRows.map(r => convert(r.tmin)).filter(v => v !== null);
    dailyReferenceValues.tmax = dailyRows.map(r => convert(r.tmax)).filter(v => v !== null);

    const finalAvgMax = getAvg(dailyReferenceValues.tmax);
    const finalAvgMin = getAvg(dailyReferenceValues.tmin);

    // Update Daily Averages
    document.getElementById('avgMax').textContent = finalAvgMax + unit;
    document.getElementById('avgMin').textContent = finalAvgMin + unit;

    // Update Historical Monthly Averages
    document.getElementById('monMax').textContent = getAvg(periodData.map(r => convert(r.tmax)).filter(v => v !== null)) + unit;
    document.getElementById('monMin').textContent = getAvg(periodData.map(r => convert(r.tmin)).filter(v => v !== null)) + unit;

    // --- 2026 CURRENT MONTH CARDS UPDATES ---
    const currYear = 2026;
    const todayDate = new Date();
    const currentSystemMonth = todayDate.getMonth() + 1; 
    
    const minCard2026 = document.getElementById('currMonthMin').parentElement;
    const maxCard2026 = document.getElementById('currMonthMax').parentElement;

    if (mIdx > currentSystemMonth) {
        minCard2026.style.display = 'none';
        maxCard2026.style.display = 'none';
    } else {
        minCard2026.style.display = 'block';
        maxCard2026.style.display = 'block';
        
        const currYearData = rawMonthData.filter(d => d.year === currYear);
        const validDays = currYearData.filter(d => d.tmin !== null || d.tmax !== null).map(d => d.day);
        
        let latestDateLabel = "";
        if (validDays.length > 0) {
            const latestDay = Math.max(...validDays);
            // Updated color here to var(--sub-text)
            latestDateLabel = `<br><span style="font-size:0.65rem; color:var(--sub-text); font-weight:400; text-transform:none;">Latest Data: ${monthName} ${latestDay}, ${currYear}</span>`;
        }

        document.getElementById('currMonthMinLabel').innerHTML = `${monthName} ${currYear} Average Minimum Temperature ${latestDateLabel}`;
        document.getElementById('currMonthMaxLabel').innerHTML = `${monthName} ${currYear} Average Maximum Temperature ${latestDateLabel}`;

        document.getElementById('currMonthMin').textContent = getAvg(currYearData.map(r => convert(r.tmin)).filter(v => v !== null)) + unit;
        document.getElementById('currMonthMax').textContent = getAvg(currYearData.map(r => convert(r.tmax)).filter(v => v !== null)) + unit;
    }

    if (mIdx === (todayDate.getMonth() + 1) && dReq === todayDate.getDate()) {
        fetchLiveComparison(lastStation.lat, lastStation.lon, finalAvgMax, finalAvgMin);
    } else {
        document.getElementById('liveRow').style.display = 'none';
    }

    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const baseLayout = { 
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
      font: { color: isDark ? "#e0e0e0" : "#2d3436", family: 'Inter, sans-serif', size: 10 },
      yaxis: { title: unit, gridcolor: isDark ? "#333" : "#f1f2f6", zeroline: false }, 
      margin: { t: 60, b: 40, l: 40, r: 20 }, template: isDark ? 'plotly_dark' : 'plotly_white'
    };

    if(dailyRows.length > 0) {
      Plotly.newPlot('boxDiv', [
        { 
          y: dailyReferenceValues.tmin, 
          text: dailyRows.filter(r => r.tmin !== null).map(r => r.year),
          type:'box', name:'Min', boxpoints: 'all', jitter: 0.5, pointpos: -1.8,
          marker: {color: '#74b9ff'}, hovertemplate: 'Year: %{text}<br>Temp: %{y:.1f}' + unit + '<extra></extra>'
        },
        { 
          y: dailyReferenceValues.tmax, 
          text: dailyRows.filter(r => r.tmax !== null).map(r => r.year),
          type:'box', name:'Max', boxpoints: 'all', jitter: 0.5, pointpos: 1.8,
          marker: {color: '#ff7675'}, hovertemplate: 'Year: %{text}<br>Temp: %{y:.1f}' + unit + '<extra></extra>'
        }
      ], { ...baseLayout, title: `<b>${monthName} ${dReq} Temperature Distribution</b>` });

      Plotly.newPlot('lineDiv', [
        { 
          x: dailyRows.map(r => r.year), y: dailyReferenceValues.tmax, 
          text: dailyRows.map(r => r.year), type:'scatter', name:'Max', line: {color: '#ff7675'},
          hovertemplate: 'Year: %{text}<br>Temp: %{y:.1f}' + unit + '<extra></extra>'
        },
        { 
          x: dailyRows.map(r => r.year), y: dailyReferenceValues.tmin, 
          text: dailyRows.map(r => r.year), type:'scatter', name:'Min', line: {color: '#74b9ff'},
          hovertemplate: 'Year: %{text}<br>Temp: %{y:.1f}' + unit + '<extra></extra>'
        }
      ], { ...baseLayout, title: `<b>${monthName} ${dReq} Historical Trend</b>` });
    }
  }
  window.addEventListener('resize', () => { Plotly.Plots.resize('boxDiv'); Plotly.Plots.resize('lineDiv'); });
});
</script>
</body>
</html>