<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Climate Analytics Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary: #007bff;
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --text: #2d3436;
      --sub-text: #95a5a6;
      --max-color: #ff7675;
      --min-color: #74b9ff;
      --border: #dfe6e9;
      --ribbon-bg: #e9ecef;
      --map-invert: 0;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --sub-text: #a0a0a0;
        --border: #333; --ribbon-bg: #2d2d2d; --map-invert: 0.9;
      }
    }

    body { margin:0; padding:0; font-family:'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); transition: background 0.3s; }
    .top-header { text-align: center; margin: 30px 0 5px 0; font-weight: 300; }
    #stationHeader { text-align: center; margin-bottom: 20px; color: var(--primary); font-weight: 600; font-size: 1.5rem; }
    
    #controls { margin: 0 auto 15px auto; padding: 15px 35px; background: var(--card-bg); border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; gap: 30px; align-items: center; justify-content: center; width: fit-content; border: 1px solid var(--border); }

    #periodRibbon { margin: 0 auto 30px auto; display: flex; justify-content: center; gap: 8px; padding: 5px; background: var(--ribbon-bg); width: fit-content; border-radius: 30px; }
    .period-btn { padding: 10px 20px; border: none; background: transparent; border-radius: 25px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--sub-text); transition: 0.3s; }
    .period-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,123,255,0.4); }

    /* Stats Section */
    .stats-section { margin-bottom: 30px; }
    .stats-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; }
    .stat-card {
      background: var(--card-bg); padding: 15px 25px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center; min-width: 240px; border: 1px solid var(--border);
    }
    .stat-card.min { border-bottom: 4px solid var(--min-color); }
    .stat-card.max { border-bottom: 4px solid var(--max-color); }
    .stat-card.monthly { opacity: 0.85; transform: scale(0.95); }
    .stat-value { font-size: 1.8rem; font-weight: 700; display: block; }
    .stat-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--sub-text); }

    #map { height: 420px; width: 92%; max-width: 1200px; margin: 0 auto 35px auto; border-radius: 25px; box-shadow: 0 15px 45px rgba(0,0,0,0.3); background: var(--card-bg); filter: invert(var(--map-invert)) hue-rotate(180deg) brightness(0.9); border: 1px solid var(--border); }
    #plots { display: flex; justify-content: center; padding: 0 4%; flex-wrap: wrap; gap: 25px; margin-bottom: 60px; }
    #boxDiv, #lineDiv { background: var(--card-bg); padding: 20px; border-radius: 25px; width: 46%; height: 450px; min-width: 420px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); border: 1px solid var(--border); }

    .input-group { display: flex; align-items: center; gap: 10px; }
    input { background: var(--card-bg); color: var(--text); padding: 8px; border: 1px solid var(--border); border-radius: 12px; width: 60px; text-align: center; outline: none; }
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(24px); }
  </style>
</head>
<body>

<h2 class="top-header">Climate Analytics Dashboard</h2>
<div id="stationHeader">Select a station marker</div>

<div id="controls">
  <div class="input-group"><label>Month</label><input type="number" id="month" min="1" max="12"></div>
  <div class="input-group"><label>Day</label><input type="number" id="day" min="1" max="31"></div>
  <div class="switch-container">
    <span style="color:var(--sub-text)">째C</span>
    <label class="switch"><input type="checkbox" id="unitToggle"><span class="slider"></span></label>
    <span style="color:var(--primary)">째F</span>
  </div>
</div>

<div id="periodRibbon">
  <button class="period-btn" data-start="1961" data-end="1990">1961-1990</button>
  <button class="period-btn" data-start="1971" data-end="2000">1971-2000</button>
  <button class="period-btn" data-start="1981" data-end="2010">1981-2010</button>
  <button class="period-btn" data-start="1991" data-end="2020" id="defaultPeriod">1991-2020</button>
  <button class="period-btn" data-start="0" data-end="9999">All History</button>
</div>

<div class="stats-section">
  <div class="stats-row">
    <div class="stat-card min"><span class="stat-label">Daily Average Minimum Temperature</span><span class="stat-value" id="avgMin">--</span></div>
    <div class="stat-card max"><span class="stat-label">Daily Average Maximum Temperature</span><span class="stat-value" id="avgMax">--</span></div>
  </div>
  <div class="stats-row">
    <div class="stat-card min monthly"><span class="stat-label">Monthly Average Minimum Temperature</span><span class="stat-value" id="monMin">--</span></div>
    <div class="stat-card max monthly"><span class="stat-label">Monthly Average Maximum Temperature</span><span class="stat-value" id="monMax">--</span></div>
  </div>
</div>

<div id="map"></div>
<div id="plots">
  <div id="boxDiv"></div>
  <div id="lineDiv"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date();
  document.getElementById('month').value = today.getMonth() + 1;
  document.getElementById('day').value = today.getDate();

  let lastStation = null, rawMonthData = null, currentRange = { start: 1991, end: 2020 };
  document.getElementById('defaultPeriod').classList.add('active');

  const map = L.map('map').setView([35.5, -80], 7);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

  Papa.parse('data/stations.csv', {
    download: true, header: true, skipEmptyLines: true,
    complete: function(results) {
      results.data.forEach(station => {
        if(!station.lat || !station.lon) return;
        L.marker([parseFloat(station.lat), parseFloat(station.lon)]).addTo(map).bindTooltip(station.name)
         .on('click', () => { 
           lastStation = station; 
           document.getElementById('stationHeader').innerHTML = `Station: <span style="color:var(--text)">${station.name}</span>`;
           triggerDataFetch(); 
         });
      });
    }
  });

  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentRange.start = parseInt(this.dataset.start);
      currentRange.end = parseInt(this.dataset.end);
      processAndPlot();
    });
  });

  document.getElementById('month').addEventListener('change', triggerDataFetch);
  document.getElementById('day').addEventListener('change', triggerDataFetch);
  document.getElementById('unitToggle').addEventListener('change', processAndPlot);

  function triggerDataFetch() {
    if (!lastStation) return;
    const mReq = parseInt(document.getElementById('month').value);
    Papa.parse(`data/daily/${lastStation.station}.csv`, {
      download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
      complete: function(results) {
        // We now store the entire MONTH of data
        rawMonthData = results.data.filter(d => {
          if (!d.DATE) return false;
          return parseInt(d.DATE.split('-')[1]) === mReq;
        }).map(r => ({
          year: parseInt(r.DATE.split('-')[0]),
          day: parseInt(r.DATE.split('-')[2]),
          tmax: (r.TMAX != null) ? r.TMAX/10 : null,
          tmin: (r.TMIN != null) ? r.TMIN/10 : null
        }));
        processAndPlot();
      }
    });
  }

  function processAndPlot() {
    if (!rawMonthData) return;
    const dReq = parseInt(document.getElementById('day').value);
    const isF = document.getElementById('unitToggle').checked;
    const unit = isF ? "째F" : "째C";
    const convert = (v) => (v == null ? null : (isF ? (v * 9/5 + 32) : v));

    // 1. Filter all data for the chosen period
    const periodData = rawMonthData.filter(d => d.year >= currentRange.start && d.year <= currentRange.end);
    
    // 2. Separate Daily vs Monthly averages
    const dailyRows = periodData.filter(d => d.day === dReq);
    
    const tmaxDaily = dailyRows.map(r => convert(r.tmax)).filter(v => v !== null);
    const tminDaily = dailyRows.map(r => convert(r.tmin)).filter(v => v !== null);
    
    const tmaxMonth = periodData.map(r => convert(r.tmax)).filter(v => v !== null);
    const tminMonth = periodData.map(r => convert(r.tmin)).filter(v => v !== null);

    const getAvg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : "--";

    document.getElementById('avgMax').textContent = getAvg(tmaxDaily) + unit;
    document.getElementById('avgMin').textContent = getAvg(tminDaily) + unit;
    document.getElementById('monMax').textContent = getAvg(tmaxMonth) + unit;
    document.getElementById('monMin').textContent = getAvg(tminMonth) + unit;

    if(dailyRows.length === 0) return;

    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const layout = { 
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
      font: { color: isDark ? "#e0e0e0" : "#2d3436" },
      yaxis: { title: unit, gridcolor: isDark ? "#333" : "#f1f2f6", zeroline: false }, 
      xaxis: { title: "Year", gridcolor: isDark ? "#333" : "#f1f2f6", zeroline: false },
      margin: { t: 40, b: 40, l: 60, r: 20 }, legend: { orientation: 'h', y: -0.2 },
      template: isDark ? 'plotly_dark' : 'plotly_white'
    };

    Plotly.newPlot('boxDiv', [
      { y: tminDaily, type:'box', name:'Min', marker: {color: '#74b9ff'}, boxpoints:'all', jitter:0.3 },
      { y: tmaxDaily, type:'box', name:'Max', marker: {color: '#ff7675'}, boxpoints:'all', jitter:0.3 }
    ], { ...layout, title: "<b>Daily Distribution</b>" });

    Plotly.newPlot('lineDiv', [
      { x: dailyRows.map(r => r.year), y: tminDaily, type:'scatter', mode:'lines+markers', name:'Min', line: {color: '#74b9ff', width: 3} },
      { x: dailyRows.map(r => r.year), y: tmaxDaily, type:'scatter', mode:'lines+markers', name:'Max', line: {color: '#ff7675', width: 3} }
    ], { ...layout, title: "<b>Historical Daily Trend</b>" });
  }
});
</script>
</body>
</html>